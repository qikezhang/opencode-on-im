#!/bin/bash
# Container initialization script
# Runs before services start

set -e

echo "[init] OpenCode Cloudify initializing..."

# Ensure data directory permissions
chown -R cloudify:cloudify /data 2>/dev/null || true

# Create default config if not exists
if [ ! -f /data/config.yaml ]; then
    echo "[init] Creating default configuration..."
    cat > /data/config.yaml <<EOF
# OpenCode Cloudify Configuration
# Edit this file to configure your IM bots

# Telegram Bot (get token from @BotFather)
telegram:
  enabled: ${TELEGRAM_TOKEN:+true}
  token: "${TELEGRAM_TOKEN:-}"

# DingTalk Bot (Enterprise internal app)
dingtalk:
  enabled: ${DINGTALK_APP_KEY:+true}
  app_key: "${DINGTALK_APP_KEY:-}"
  app_secret: "${DINGTALK_APP_SECRET:-}"
  agent_id: "${DINGTALK_AGENT_ID:-}"

# OpenCode connection
opencode:
  host: "127.0.0.1"
  port: ${OPENCODE_PORT:-4096}

# Data directory
data_dir: "/data"

# Secret key for session signing
secret_key: "${OPENCODE_IM__SECRET_KEY:-$(openssl rand -hex 32)}"
EOF
    chown cloudify:cloudify /data/config.yaml
fi

# Configure proxy if provided
if [ -n "$RESIDENTIAL_PROXY_URL" ]; then
    echo "[init] Configuring residential proxy..."
    export HTTP_PROXY="$RESIDENTIAL_PROXY_URL"
    export HTTPS_PROXY="$RESIDENTIAL_PROXY_URL"
    export http_proxy="$RESIDENTIAL_PROXY_URL"
    export https_proxy="$RESIDENTIAL_PROXY_URL"
fi

# Check for version updates (non-blocking)
if [ "${SKIP_UPDATE_CHECK:-false}" != "true" ]; then
    echo "[init] Checking for updates..."
    curl -sf --max-time 5 \
        "https://api.github.com/repos/opencode-cloudify/opencode-on-im/releases/latest" \
        2>/dev/null | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    latest = data.get('tag_name', 'unknown')
    print(f'[init] Latest version: {latest}')
except:
    pass
" || true
fi

echo "[init] Initialization complete"
