#!/bin/bash
# Health check script for Docker HEALTHCHECK
# Checks all critical services and returns appropriate exit code

set -o pipefail

OPENCODE_PORT="${OPENCODE_PORT:-4096}"
TTYD_PORT="${TTYD_PORT:-7681}"

# Health check results
declare -A health_status
overall_status=0

# Check ttyd (Web Terminal) - primary external interface
check_ttyd() {
    if curl -sf --max-time 5 "http://127.0.0.1:${TTYD_PORT}/" >/dev/null 2>&1; then
        health_status["ttyd"]="ok"
        return 0
    else
        health_status["ttyd"]="fail"
        return 1
    fi
}

# Check OpenCode API
check_opencode() {
    if curl -sf --max-time 5 "http://127.0.0.1:${OPENCODE_PORT}/health" >/dev/null 2>&1; then
        health_status["opencode"]="ok"
        return 0
    else
        health_status["opencode"]="fail"
        return 1
    fi
}

# Check IM Bot process
check_im_bot() {
    if pgrep -f "opencode_on_im" >/dev/null 2>&1; then
        health_status["im-bot"]="ok"
        return 0
    else
        health_status["im-bot"]="fail"
        return 1
    fi
}

# Run checks
check_ttyd || overall_status=1
check_opencode || overall_status=1
check_im_bot || overall_status=1

# Output status (useful for debugging)
if [ "$1" = "-v" ] || [ "$1" = "--verbose" ]; then
    echo "Health Check Results:"
    for service in "${!health_status[@]}"; do
        echo "  ${service}: ${health_status[$service]}"
    done
fi

# Return overall status
# Exit 0 = healthy, Exit 1 = unhealthy
exit $overall_status
